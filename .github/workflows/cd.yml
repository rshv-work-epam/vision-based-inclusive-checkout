name: CD

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'infrastructure/bicep/**'
      - '.github/workflows/cd.yml'

permissions:
  id-token: write
  contents: read

env:
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
  AZURE_LOCATION: ${{ secrets.AZURE_LOCATION }}
  ACR_NAME: ${{ secrets.ACR_NAME }}

jobs:
  deploy-infra:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy Bicep
        uses: azure/arm-deploy@v2
        with:
          scope: resourcegroup
          subscriptionId: ${{ env.AZURE_SUBSCRIPTION_ID }}
          resourceGroupName: ${{ env.AZURE_RESOURCE_GROUP }}
          template: infrastructure/bicep/main.bicep
          parameters: infrastructure/bicep/parameters/main.parameters.json location=${{ env.AZURE_LOCATION }} acrName=${{ env.ACR_NAME }}

  build-and-push-images:
    needs: deploy-infra
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [catalog, inference, review-tasks, operator-assistant]
    steps:
      - uses: actions/checkout@v4

      - name: Log in to Azure Container Registry
        uses: azure/docker-login@v2
        with:
          login-server: ${{ env.ACR_NAME }}.azurecr.io
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and Push
        uses: docker/build-push-action@v6
        with:
          context: services/${{ matrix.service }}
          push: true
          tags: |
            ${{ env.ACR_NAME }}.azurecr.io/vbic-${{ matrix.service }}:latest
            ${{ env.ACR_NAME }}.azurecr.io/vbic-${{ matrix.service }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy-apps:
    needs: build-and-push-images
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}

      - name: Install Azure CLI extensions
        uses: azure/CLI@v2
        with:
          inlineScript: |
            az extension add --name containerapp --upgrade

      - name: Deploy Container Apps
        uses: azure/CLI@v2
        with:
          inlineScript: |
            CA_ENV=$(az containerapp env list -g $AZURE_RESOURCE_GROUP --query "[0].name" -o tsv)
            for SVC in catalog inference review-tasks operator-assistant; do
              IMAGE="${ACR_NAME}.azurecr.io/vbic-${SVC}:${GITHUB_SHA}"
              az containerapp update \
                -g $AZURE_RESOURCE_GROUP \
                -n vbic-$SVC \
                --image $IMAGE \
                --set-env-vars "OTEL_EXPORTER_OTLP_ENDPOINT=https://otlp.azure.com:4317" \
                --set-env-vars "ENVIRONMENT=prod"
            done
